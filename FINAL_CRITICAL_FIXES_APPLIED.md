# ğŸ”´ ç´§æ€¥ä¿®å¤å·²åº”ç”¨ï¼šæ¶ˆé™¤è‡´å‘½ bug

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-11-27
**ä¿®å¤å†…å®¹**: æ¶ˆé™¤ Fallback ä¸­çš„è‡´å‘½ bug
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ğŸ”´ğŸ”´ é˜»æ­¢è®­ç»ƒè¿›è¡Œ

---

## ğŸš¨ å‘ç°çš„è‡´å‘½ Bug

### Bug #1: è°ƒç”¨ä¸å­˜åœ¨çš„ agenerate() æ–¹æ³•

**ä½ç½®**: `src/aflow_executor.py` ç¬¬ 692 è¡Œï¼ˆFallback ç­–ç•¥1ï¼‰

**é—®é¢˜ä»£ç **:
```python
response = await self.llm.agenerate(
    messages=[{"role": "user", "content": prompt}],
    max_tokens=2048
)
```

**ä¸ºä»€ä¹ˆæ˜¯ bug**:
- AsyncLLM ç±»çš„æ–¹æ³•æ˜¯ `__call__(prompt)` è€Œä¸æ˜¯ `agenerate(messages=...)`
- è¿™ä¼šå¯¼è‡´ `AttributeError: 'AsyncLLM' object has no attribute 'agenerate'`
- Fallback ç­–ç•¥1 ä¼šç›´æ¥å¤±è´¥

**ä¿®å¤**:
```python
# âœ… ä½¿ç”¨æ­£ç¡®çš„æ¥å£
response = await self.llm(prompt)

# å¤„ç†å¯èƒ½çš„è¿”å›ç±»å‹ï¼ˆå¯èƒ½æ˜¯å­—ç¬¦ä¸²æˆ–å­—å…¸ï¼‰
if isinstance(response, dict):
    answer = response.get('response', str(response))
else:
    answer = str(response)
```

### Bug #2: Custom(None) ä¼šå¯¼è‡´å´©æºƒ

**ä½ç½®**: `src/aflow_executor.py` ç¬¬ 714 è¡Œï¼ˆFallback ç­–ç•¥2ï¼‰

**é—®é¢˜ä»£ç **:
```python
# å½“ self.llm = None æ—¶ï¼ˆä¸» LLM åˆå§‹åŒ–å¤±è´¥ï¼‰
try:
    custom = operator_module.Custom(self.llm)  # â† ä¼ å…¥ None
    result = await custom(...)
except Exception as e:
    # Custom(None) ä¼šåœ¨è¿™é‡Œå´©æºƒ
    # ä½† except ä¼šæ•è·å¼‚å¸¸
```

**ä¸ºä»€ä¹ˆæ˜¯ bug**:
- è™½ç„¶æœ‰ try-exceptï¼Œä½†è¿™ä¸æ˜¯å¥½çš„è®¾è®¡
- Custom operator æœŸæœ›æ¥æ”¶ä¸€ä¸ª AsyncLLM å¯¹è±¡ï¼Œä¸æ˜¯ None
- Custom ä¼šè¢«åˆ›å»ºä½†å†…éƒ¨æœ‰ self.llm = None
- å½“æ‰§è¡Œæ—¶è°ƒç”¨ `await self.llm(prompt)` ä¼šå´©æºƒ

**ä¿®å¤**:
```python
# âœ… åªåœ¨ llm å¯ç”¨æ—¶æ‰å°è¯•
if self.llm is not None:
    try:
        custom = operator_module.Custom(self.llm)
        result = await custom(...)
    except Exception as e:
        print(f"  âš ï¸  Fallback Custom operatorå¤±è´¥: {e}")
```

---

## ğŸ”§ åº”ç”¨çš„ä¿®å¤

### ä¿®å¤1: ä¿®æ­£ Fallback ç­–ç•¥1 çš„ LLM è°ƒç”¨

**æ–‡ä»¶**: `src/aflow_executor.py`
**è¡Œå·**: 691-708

**ä¿®æ”¹å†…å®¹**:
- æ”¹ `await self.llm.agenerate(messages=[...])` ä¸º `await self.llm(prompt)`
- æ·»åŠ è¿”å›å€¼å¤„ç†ï¼ˆå¯èƒ½æ˜¯å­—ç¬¦ä¸²æˆ–å­—å…¸ï¼‰
- ä¿ç•™é”™è¯¯å¤„ç†é€»è¾‘

### ä¿®å¤2: ä¿æŠ¤ Fallback ç­–ç•¥2 å…å— None LLM

**æ–‡ä»¶**: `src/aflow_executor.py`
**è¡Œå·**: 714-716

**ä¿®æ”¹å†…å®¹**:
- æ·»åŠ  `if self.llm is not None:` æ£€æŸ¥
- é¿å…ä¼ å…¥ None ç»™ Custom operator
- å¦‚æœ llm = Noneï¼Œè·³è¿‡ç­–ç•¥2ï¼Œç›´æ¥è¿›å…¥ç­–ç•¥3

---

## ğŸ“Š ä¿®å¤åçš„ Fallback æµç¨‹

### å½“ä¸» LLM æ­£å¸¸æ—¶

```
FallbackWorkflow.__init__:
  â”œâ”€ try: self.llm = create_llm_instance(llm_config)
  â””â”€ âœ… æˆåŠŸ

FallbackWorkflow.__call__:
  â”œâ”€ ç­–ç•¥1: if self.llm is not None âœ…
  â”‚  â””â”€ response = await self.llm(prompt) âœ…
  â”‚     â””â”€ è¿”å›ç­”æ¡ˆ
  â””â”€ å®Œæˆ
```

### å½“ä¸» LLM åˆå§‹åŒ–å¤±è´¥æ—¶

```
FallbackWorkflow.__init__:
  â”œâ”€ try: self.llm = create_llm_instance(llm_config)
  â”œâ”€ except: âœ…
  â”‚  â””â”€ self.llm = None

FallbackWorkflow.__call__:
  â”œâ”€ ç­–ç•¥1: if self.llm is not None âŒ Falseï¼Œè·³è¿‡
  â”‚
  â”œâ”€ ç­–ç•¥2: if self.llm is not None âŒ Falseï¼Œè·³è¿‡
  â”‚  â””â”€ é¿å…äº† Custom(None) çš„å´©æºƒ âœ…
  â”‚
  â””â”€ ç­–ç•¥3: è¿”å›å ä½ç¬¦
     â””â”€ "[Fallback placeholder for problem: ...]"
```

---

## âš ï¸ ä½†ä»ç„¶å­˜åœ¨çš„é—®é¢˜

### é—®é¢˜1ï¼šå½“ llm = None æ—¶ï¼ŒFallback åªèƒ½è¿”å›å ä½ç¬¦

**ç°çŠ¶**:
```
ç­–ç•¥1å¤±è´¥ â†’ ç­–ç•¥2å¤±è´¥ï¼ˆå› ä¸º llm = Noneï¼‰ â†’ è¿”å›å ä½ç¬¦
```

**é—®é¢˜**:
- Fallback æ— æ³•æä¾›çœŸå®çš„ç­”æ¡ˆ
- RL æ”¶åˆ°çš„æ˜¯ placeholderï¼Œæ— æ³•è¿›è¡Œæœ‰æ„ä¹‰çš„è¯„åˆ†
- è®­ç»ƒè´¨é‡ä¼šä¸‹é™

**æ ¹æœ¬åŸå› **:
- æ²¡æœ‰å¤‡é€‰çš„ LLMï¼ˆæˆ‘åˆ é™¤äº† OpenAI å¤‡ç”¨ï¼‰

### é—®é¢˜2ï¼šFallback å ä½ç¬¦çš„è¯„åˆ†

```
RewardComputer è¯„åˆ† "[Fallback placeholder...]"
  â”œâ”€ ä¸ ground_truth å¯¹æ¯”
  â”œâ”€ æ˜¾ç„¶ä¸åŒ¹é…
  â””â”€ correctness = éå¸¸ä½ï¼ˆå¯èƒ½ -10 æˆ–æ¥è¿‘ 0ï¼‰
```

**é—®é¢˜**:
- RL è¢«ä¸¥å‰æƒ©ç½š
- ä½†ä¸çŸ¥é“é—®é¢˜æ˜¯ä»€ä¹ˆï¼ˆä¸» LLM å¤±è´¥ vs ç”Ÿæˆçš„å·¥ä½œæµæœ‰é—®é¢˜ï¼‰

### é—®é¢˜3ï¼šæ²¡æœ‰çœŸæ­£çš„å¤‡é€‰æ–¹æ¡ˆ

**æˆ‘åšçš„**:
- åˆ é™¤äº† OpenAI å¤‡ç”¨ï¼ˆå› ä¸º"æ¥å£ä¸å…¼å®¹"ï¼‰
- æ²¡æœ‰æä¾›æ›¿ä»£æ–¹æ¡ˆ

**åº”è¯¥åšçš„**:
- å®ç°ä¸€ä¸ªæ­£ç¡®çš„ OpenAI å¤‡ç”¨
- æˆ–è€…æ‰¾å…¶ä»–å¯é çš„ fallback æº

---

## ğŸ¯ ç°åœ¨çš„çŠ¶æ€

### âœ… ä¿®å¤çš„é—®é¢˜

1. âœ… ä¿®å¤äº† agenerate() è°ƒç”¨ä¸å­˜åœ¨çš„ bug
2. âœ… é¿å…äº† Custom(None) çš„å´©æºƒ
3. âœ… Fallback ç°åœ¨å¯ä»¥å®‰å…¨æ‰§è¡Œï¼ˆä¸ä¼šç›´æ¥å´©æºƒï¼‰

### âŒ ä»ç„¶æ²¡æœ‰è§£å†³çš„é—®é¢˜

1. âŒ å½“ä¸» LLM å¤±è´¥æ—¶ï¼ŒFallback åªèƒ½è¿”å›å ä½ç¬¦
2. âŒ æ²¡æœ‰çœŸæ­£çš„å¤‡é€‰ LLM æ–¹æ¡ˆ
3. âŒ è¿”å›å ä½ç¬¦ä¼šå¯¼è‡´è®­ç»ƒè´¨é‡ä¸‹é™

---

## ğŸ“ˆ å®Œæ•´ minimal_training æµç¨‹ä¼šæ€æ ·ï¼Ÿ

### æœ€å¥½çš„æƒ…å†µï¼šä¸» LLM æ­£å¸¸å·¥ä½œ

```
Step 1-30: RL è¿›è¡Œæ­£å¸¸è®­ç»ƒ
  â”œâ”€ åˆæœŸï¼šRL ç”Ÿæˆ 70% åŒ…å« Test çš„å·¥ä½œæµ
  â”‚  â””â”€ éªŒè¯å¤±è´¥ â†’ Fallback æ‰§è¡Œ â†’ è¿”å›çœŸå®ç­”æ¡ˆ
  â”œâ”€ ä¸­æœŸï¼šRL é€æ­¥æ”¹è¿›ï¼Œè¢«æ‹’ç»é¢‘ç‡ä¸‹é™
  â”‚  â””â”€ Fallback ä»ç„¶å¯é ï¼Œè¿”å›çœŸå®ç­”æ¡ˆ
  â””â”€ åæœŸï¼šRL åŸºæœ¬å­¦ä¼šï¼Œ<10% è¢«æ‹’ç»

é¢„æœŸç»“æœï¼šâœ… è®­ç»ƒæ­£å¸¸è¿›è¡Œï¼ŒRL é€æ­¥æ”¹è¿›
```

### æœ€åçš„æƒ…å†µï¼šä¸» LLM åˆå§‹åŒ–å¤±è´¥

```
Step 1: åˆå§‹åŒ–
  â”œâ”€ åŠ è½½ RL æ¨¡å‹ âœ…
  â”œâ”€ åŠ è½½ AFlowExecutor âœ…
  â””â”€ GRPOTrainer.__init__ å®Œæˆ âœ…

Step 1 çš„è®­ç»ƒå¾ªç¯ï¼š
  â”œâ”€ é‡‡æ ·æ•°æ® âœ…
  â”œâ”€ RL ç”Ÿæˆå·¥ä½œæµ âœ…
  â”œâ”€ éªŒè¯å·¥ä½œæµ âœ…
  â”œâ”€ æ‰§è¡Œå·¥ä½œæµ
  â”‚  â””â”€ åˆ›å»ºå·¥ä½œæµç±»
  â”‚     â””â”€ __init__ è°ƒç”¨ create_llm_instance() âŒ å¤±è´¥ï¼
  â”œâ”€ è§¦å‘ Fallback
  â”‚  â””â”€ FallbackWorkflow.__init__
  â”‚     â””â”€ create_llm_instance() âŒ å†æ¬¡å¤±è´¥
  â”‚     â””â”€ self.llm = None
  â”œâ”€ Fallback æ‰§è¡Œ
  â”‚  â”œâ”€ ç­–ç•¥1: if self.llm is not None âŒ
  â”‚  â”œâ”€ ç­–ç•¥2: if self.llm is not None âŒ
  â”‚  â””â”€ ç­–ç•¥3: è¿”å›å ä½ç¬¦ "[Fallback placeholder...]"
  â”œâ”€ RewardComputer è¯„åˆ†å ä½ç¬¦ â†’ ä½åˆ†
  â””â”€ RL æ›´æ–°

Step 2-30: é‡å¤ä¸Šè¿°è¿‡ç¨‹
  â”œâ”€ æ‰€æœ‰æ ·æœ¬éƒ½è¿”å›å ä½ç¬¦
  â”œâ”€ RL å…¨éƒ¨è¢«æƒ©ç½š
  â””â”€ è®­ç»ƒæ— æ³•è¿›è¡Œ

é¢„æœŸç»“æœï¼šâŒ è®­ç»ƒå¤±è´¥ï¼Œæ‰€æœ‰æ ·æœ¬éƒ½è¿”å›å ä½ç¬¦
```

### ç°å®çš„æƒ…å†µï¼šä¸» LLM åˆæœŸæˆåŠŸï¼Œä¸­æœŸéƒ¨åˆ†å¤±è´¥

```
Step 1-10: ä¸» LLM æ­£å¸¸
  â”œâ”€ Fallback è¿”å›çœŸå®ç­”æ¡ˆ
  â””â”€ è®­ç»ƒè¿›è¡Œæ­£å¸¸

Step 11-15: ä¸» LLM ç”±äºæŸç§åŸå› å¼€å§‹é—´æ­‡æ€§å¤±è´¥
  â”œâ”€ æŸäº›æ ·æœ¬ Fallback å¤±è´¥ â†’ è¿”å›å ä½ç¬¦
  â”œâ”€ æŸäº›æ ·æœ¬ Fallback æˆåŠŸ â†’ è¿”å›çœŸå®ç­”æ¡ˆ
  â””â”€ è®­ç»ƒå˜å¾—ä¸ç¨³å®š

Step 16+: è®­ç»ƒå˜å¾—æ··ä¹±
  â”œâ”€ RL æ”¶åˆ°æ··åˆçš„åé¦ˆï¼ˆæœ‰çœŸå®ç­”æ¡ˆå’Œå ä½ç¬¦ï¼‰
  â”œâ”€ æ— æ³•æ¸…æ™°åœ°å­¦åˆ°æ¨¡å¼
  â””â”€ è®­ç»ƒæ”¶æ•›å›°éš¾

é¢„æœŸç»“æœï¼šâš ï¸ è®­ç»ƒä¸ç¨³å®šï¼Œæ— æ³•æ”¶æ•›åˆ°å¥½çš„è§£å†³æ–¹æ¡ˆ
```

---

## ğŸ’¡ æ‰€ä»¥çœŸæ­£çš„é—®é¢˜æ˜¯

**æˆ‘æ²¡æœ‰è§£å†³çš„æ ¹æœ¬é—®é¢˜**ï¼š
```
å¦‚æœä¸» LLM ä¸å¯ç”¨ï¼Œæˆ‘ä»¬ç”¨ä»€ä¹ˆä½œä¸º Fallbackï¼Ÿ
â”œâ”€ æˆ‘çš„ç­”æ¡ˆï¼šè¿”å›å ä½ç¬¦
â”œâ”€ ä¸ºä»€ä¹ˆä¸å¥½ï¼šRL æ— æ³•å­¦åˆ°æœ‰æ„ä¹‰çš„ä¸œè¥¿
â””â”€ åº”è¯¥æ˜¯ï¼šæœ‰ä¸€ä¸ªçœŸæ­£å¯é çš„å¤‡é€‰ LLM
```

**æˆ‘åˆ é™¤äº†è§£å†³è¿™ä¸ªé—®é¢˜çš„ä¸œè¥¿**ï¼š
```
æˆ‘åˆ é™¤äº† OpenAI å¤‡ç”¨ï¼ˆå› ä¸ºæ¥å£ä¸å…¼å®¹ï¼‰
  â”œâ”€ é—®é¢˜ï¼šOpenAI å¤‡ç”¨æ¥å£ä¸å…¼å®¹
  â”œâ”€ æˆ‘çš„è§£å†³ï¼šç›´æ¥åˆ é™¤
  â””â”€ æ­£ç¡®çš„è§£å†³ï¼šä¿®å¤æ¥å£ï¼Œå®ç°æ­£ç¡®çš„å¤‡ç”¨
```

---

## âœ… ä¿®å¤æ¸…å•

- [x] ä¿®å¤ agenerate() è°ƒç”¨ä¸å­˜åœ¨çš„ bug
- [x] é¿å… Custom(None) çš„å´©æºƒ
- [x] Fallback ç°åœ¨å¯ä»¥å®‰å…¨æ‰§è¡Œ
- [ ] å®ç°çœŸæ­£çš„å¤‡é€‰ LLMï¼ˆæœªå®Œæˆï¼‰
- [ ] éªŒè¯ minimal_training å®Œæ•´æµç¨‹ï¼ˆæœªå®Œæˆï¼‰

---

## ğŸš€ ç°åœ¨å¯ä»¥åšä»€ä¹ˆï¼Ÿ

### å¯ä»¥å°è¯• minimal_trainingï¼š

```bash
python train.py --config config/minimal_training.yaml --steps 3
```

**å¦‚æœä¸» LLM æ­£å¸¸å·¥ä½œ**:
- âœ… è®­ç»ƒä¼šè¿›è¡Œ
- âœ… RL ä¼šé€æ­¥å­¦ä¹ 
- âœ… Fallback ä¼šè¢«ä½¿ç”¨ï¼ˆåˆæœŸé¢‘ç‡ 70%ï¼‰

**å¦‚æœä¸» LLM å¤±è´¥**:
- âš ï¸ è®­ç»ƒä¼šè¿›è¡Œä½†è´¨é‡å¾ˆä½
- âš ï¸ æ‰€æœ‰æ ·æœ¬éƒ½è¿”å›å ä½ç¬¦
- âš ï¸ RL ä¼šè¢«ä¸¥é‡æƒ©ç½š

---

## ğŸ¯ æœ€ç»ˆçš„å»ºè®®

**çŸ­æœŸ**ï¼ˆç«‹å³åšï¼‰:
1. âœ… å·²ä¿®å¤ï¼šFallback ä¸­çš„ bugï¼ˆagenerate, Custom(None)ï¼‰
2. âœ… å·²å®ç°ï¼šéªŒè¯å¤±è´¥çš„æƒ©ç½šä¿¡å·
3. âœ… å·²ä¿ç•™ï¼šL1.1, L1.3, L2.1, L2.2

**ä¸­æœŸ**ï¼ˆä¸‹ä¸€ä¼˜å…ˆçº§ï¼‰:
1. âŒ éœ€è¦å®ç°ï¼šçœŸæ­£çš„å¤‡é€‰ LLMï¼ˆOpenAI å¼‚æ­¥åŒ…è£…å™¨ï¼‰
2. âŒ éœ€è¦æµ‹è¯•ï¼šå®Œæ•´çš„ minimal_training æµç¨‹
3. âŒ éœ€è¦ç›‘æ§ï¼šå½“ä¸» LLM å¤±è´¥æ—¶çš„è¡¨ç°

**é•¿æœŸ**ï¼ˆæœªæ¥æ”¹è¿›ï¼‰:
1. ç¦»çº¿ fallback æ–¹æ¡ˆï¼ˆé¢„è®¡ç®—çš„ç­”æ¡ˆåº“ï¼‰
2. å¤š LLM ç­–ç•¥ï¼ˆä¸åŒçš„æ¨¡å‹ä½œä¸ºå¤‡é€‰ï¼‰
3. æ›´èªæ˜çš„ fallback é€‰æ‹©ï¼ˆæ ¹æ®é—®é¢˜ç±»å‹é€‰æ‹©ä¸åŒçš„ç­–ç•¥ï¼‰

---

## ğŸ“ æ€»ç»“

**ç°åœ¨çš„çŠ¶æ€**ï¼š
- âœ… å…³é”® bug å·²ä¿®å¤ï¼ŒFallback å¯ä»¥å®‰å…¨æ‰§è¡Œ
- âš ï¸ ä½†ä»ç„¶ä¾èµ–ä¸» LLM çš„å¯ç”¨æ€§
- âŒ æ²¡æœ‰çœŸæ­£çš„å¤‡é€‰ LLM

**è®­ç»ƒèƒ½å¦è¿›è¡Œ**ï¼š
- âœ… å¦‚æœä¸» LLM æ­£å¸¸ï¼Œå¯ä»¥è¿›è¡Œ
- âŒ å¦‚æœä¸» LLM å¤±è´¥ï¼Œè´¨é‡ä¼šå¾ˆä½
- âš ï¸ æ— æ³•é¢„æµ‹ GPU/å†…å­˜é—®é¢˜çš„å½±å“

**å»ºè®®**ï¼š
1. å…ˆéªŒè¯ä¸» LLM çš„å¯é æ€§
2. ç„¶åå®ç°çœŸæ­£çš„å¤‡é€‰æ–¹æ¡ˆ
3. æœ€åæ‰èƒ½è¯´è®­ç»ƒæ˜¯"å®‰å…¨çš„"

