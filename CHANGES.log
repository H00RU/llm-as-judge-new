# 代码变更日志

## 修复: Operator未初始化问题

### 文件: src/workflow_validator.py

**新增方法 (Line 317-365)**:
```python
def _detect_uninitialized_operators(self, code: str) -> tuple
```
- 使用AST解析检测未初始化operators
- 返回: (未初始化列表, 使用列表)

**新增方法 (Line 367-416)**:
```python
def fix_uninitialized_operators(self, code: str) -> tuple
```
- 自动修复未初始化operators
- 在__init__末尾添加缺失初始化
- 返回: (修复后代码, 是否修复, 修复列表)

**修改方法 (Line 448-488)**:
```python
def validate_and_fix_workflow(self, code: str, problem_type: str = 'math') -> tuple
```
- 调用新的fix_uninitialized_operators()方法
- 返回值从5元组改为6元组
- 新增: had_uninitialized_operators标记

---

### 文件: src/aflow_executor.py

**修改 (Line 470-482)**:
```python
# 旧: 5元组
workflow_code, is_valid, msg, fixes_applied, had_signature_error = \
    self.validator.validate_and_fix_workflow(workflow_code, problem_type)

# 新: 6元组
workflow_code, is_valid, msg, fixes_applied, had_signature_error, had_uninitialized_operators = \
    self.validator.validate_and_fix_workflow(workflow_code, problem_type)
```

**新增元数据记录 (Line 480-482)**:
```python
if had_uninitialized_operators:
    metadata['had_uninitialized_operators'] = True
    print(f"  ⚠️  检测到未初始化operators（已自动修复）")
```

---

### 文件: src/reward_computer.py

**新增惩罚规则 (Line 358-363)**:
```python
# 2d. 检查是否有未初始化的operators
if execution_metadata.get('had_uninitialized_operators', False):
    generation_quality_score -= 1.5  # 未初始化: -1.5惩罚
else:
    if 'had_uninitialized_operators' in execution_metadata:
        generation_quality_score += 0.5  # 正确初始化: +0.5奖励
```

**更新打印输出 (Line 378)**:
```python
└─ 初始化: {'✅ 正确 +0.5' if not execution_metadata.get('had_uninitialized_operators') else '❌ 缺失 -1.5'}
```

---

## 修改统计

- 修改文件数: 3
- 新增代码行: ~120
- 修改代码行: ~15
- 总体影响: 低（只影响validator→executor→reward路径）

## 验证

✅ Python语法: 通过
✅ 导入检查: 通过
✅ 逻辑检查: 通过
✅ 向后兼容: 是（grpo_trainer.py无需修改）

## 回滚方式

若需回滚，恢复这3个文件到commit 6b6ff8a:
```bash
git checkout 6b6ff8a -- src/workflow_validator.py src/aflow_executor.py src/reward_computer.py
```
